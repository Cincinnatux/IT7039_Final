{% extends 'base.html' %}

{% block head %}
<title>New Entry</title>
<!-- Include Bootstrap CSS for better styling (optional) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block body %}
<div id="grid">
    <header class="box header">
        <h1>Sully's Whiskey Log</h1>
    </header>
    <nav class="box mobile-nav">
        <a href="{{ url_for('home') }}">Home Page</a>
        <a href="{{ url_for('final' )}}">Enter New Bottle</a>
        <a href="{{ url_for('random_flight') }}">Get a Random Flight</a>
        <a href="{{ url_for('analyze_inventory' )}}">Analyze Current Bottles</a>
    </nav>
    <main class="box main"></main>
    <nav class="box desktop-nav">
        <a href="{{ url_for('home') }}">Home Page&nbsp;&nbsp;&nbsp;&nbsp;</a>
        <a href="{{ url_for('final' )}}">Enter New Bottle&nbsp;&nbsp;&nbsp;&nbsp;</a>
        <a href="{{ url_for('random_flight') }}">Get a Random Flight&nbsp;&nbsp;&nbsp;&nbsp;</a>
        <a href="{{ url_for('analyze_inventory' )}}">Analyze Current Bottles&nbsp;&nbsp;&nbsp;&nbsp;</a>
    </nav>
    <aside class="box aside"></aside>
    <footer class="box footer"></footer>
</div>
<div class="container mt-4">
    <h1 class="mb-4">New Entry</h1>

    <!-- Navigation Buttons -->
    <div class="mb-3">
        <button type="button" class="btn btn-primary me-2" onclick="showForm('parent_company')">Add Parent Company</button>
        <button type="button" class="btn btn-primary me-2" onclick="showForm('distillery')">Add Distillery</button>
        <button type="button" class="btn btn-primary me-2" onclick="showForm('brand')">Add Brand</button>
        <button type="button" class="btn btn-primary me-2" onclick="showForm('bottle')">Add Bottle</button>
    </div>

    <!-- Add Record Forms -->
    <div id="forms_section">

        <!-- Parent Company Form -->
        <div id="parent_company_form" class="card mb-4" style="display:none;">
            <div class="card-header">
                <h3>Add Parent Company</h3>
            </div>
            <div class="card-body">
                <form id="add_parent_company_form">
                    <!-- CSRF Token -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label for="parent_company_name" class="form-label">Parent Company Name:</label>
                        <input type="text" class="form-control" id="parent_company_name" name="parent_company_name" required>
                    </div>
                    <!-- ... rest of the form fields ... -->
                    <button type="submit" class="btn btn-success">Add Parent Company</button>
                    <button type="button" class="btn btn-secondary" onclick="hideForm('parent_company')">Cancel</button>
                </form>
            </div>
        </div>

        <!-- Distillery Form -->
        <div id="distillery_form" class="card mb-4" style="display:none;">
            <div class="card-header">
                <h3>Add Distillery</h3>
            </div>
            <div class="card-body">
                <form id="add_distillery_form">
                    <!-- CSRF Token -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label for="dsp" class="form-label">DSP (Distillery Code):</label>
                        <input type="text" class="form-control" id="dsp" name="dsp" required>
                    </div>
                    <!-- ... rest of the form fields ... -->
                    <button type="submit" class="btn btn-success">Add Distillery</button>
                    <button type="button" class="btn btn-secondary" onclick="hideForm('distillery')">Cancel</button>
                </form>
            </div>
        </div>

        <!-- Brand Form -->
        <div id="brand_form" class="card mb-4" style="display:none;">
            <div class="card-header">
                <h3>Add Brand</h3>
            </div>
            <div class="card-body">
                <form id="add_brand_form">
                    <!-- CSRF Token -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label for="brand_name" class="form-label">Brand Name:</label>
                        <input type="text" class="form-control" id="brand_name" name="brand_name" required>
                    </div>
                    <!-- ... rest of the form fields ... -->
                    <button type="submit" class="btn btn-success">Add Brand</button>
                    <button type="button" class="btn btn-secondary" onclick="hideForm('brand')">Cancel</button>
                </form>
            </div>
        </div>

        <!-- Bottle Form -->
        <div id="bottle_form" class="card mb-4" style="display:none;">
            <div class="card-header">
                <h3>Add Bottle</h3>
            </div>
            <div class="card-body">
                <form id="add_bottle_form">
                    <!-- CSRF Token -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label for="brand_id" class="form-label">Brand:</label>
                        <select class="form-select" id="brand_id" name="brand_id" required>
                            <option value="" disabled selected>Select a Brand</option>
                            {% for brand in brands %}
                                <option value="{{ brand.brand_id }}">{{ brand.brand_name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted mt-2">
                            Can't find the brand? <a href="#" onclick="showForm('brand')">Add a new Brand</a>.
                        </small>
                    </div>
                    <!-- ... rest of the form fields ... -->
                    <button type="submit" class="btn btn-success">Add Bottle</button>
                    <button type="button" class="btn btn-secondary" onclick="hideForm('bottle')">Cancel</button>
                </form>
            </div>
        </div>

    </div>

    <!-- Search and Results Section -->
    <div class="mt-5">

        <h2>Search Records</h2>

        <!-- Search Forms -->
        <div id="search_forms">

            <!-- Parent Company Search -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Search Parent Companies</h4>
                </div>
                <div class="card-body">
                    <form id="search_parent_company_form">
                        <!-- CSRF Token -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="search_pc_name" class="form-label">Parent Company Name:</label>
                                <input type="text" class="form-control" id="search_pc_name" name="parent_company_name">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="search_pc_city" class="form-label">City:</label>
                                <input type="text" class="form-control" id="search_pc_city" name="city">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="search_pc_country" class="form-label">Country:</label>
                                <input type="text" class="form-control" id="search_pc_country" name="country">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Search Parent Companies</button>
                    </form>
                    <div id="search_parent_company_results" class="mt-4"></div>
                </div>
            </div>

            <!-- Repeat similar changes for Distillery, Brand, and Bottle Search Forms -->

        </div>

    </div>

    <!-- Display Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mt-4">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Search Results Display -->
    <div id="results_section" class="mt-5">
        <!-- Search results will be dynamically injected here -->
    </div>
</div>

<!-- Include Bootstrap JS and jQuery (optional, but useful for AJAX and modals) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript to Handle Form Display, AJAX Submissions, and Search Operations -->
<script>
    // Function to show a specific form
    function showForm(formId) {
        // Hide all forms
        $('#parent_company_form').hide();
        $('#distillery_form').hide();
        $('#brand_form').hide();
        $('#bottle_form').hide();

        // Show the selected form
        $('#' + formId + '_form').show();
    }

    // Function to hide a specific form
    function hideForm(formId) {
        $('#' + formId + '_form').hide();
    }

    // Set up AJAX to include CSRF token in headers for all non-safe methods
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", $('meta[name="csrf-token"]').attr('content'));
            }
        }
    });

    // AJAX Submission for Parent Company Form
    $('#add_parent_company_form').submit(function(event){
        event.preventDefault(); // Prevent default form submission

        $.ajax({
            url: "{{ url_for('add_parent_company') }}",
            type: "POST",
            data: $(this).serialize(), // CSRF token is included via AJAX setup
            success: function(response){
                // Append the new Parent Company to the drop-downs
                $('#parent_company_id').append('<option value="' + response.parent_company_id + '">' + response.parent_company_name + '</option>');
                $('#search_dist_parent').append('<option value="' + response.parent_company_id + '">' + response.parent_company_name + '</option>');
                
                // Optionally, select the newly added Parent Company
                $('#parent_company_id').val(response.parent_company_id);

                // Hide the Parent Company form
                hideForm('parent_company');

                // Clear the form fields
                $('#add_parent_company_form')[0].reset();

                // Show a success message (optional)
                alert('Parent Company added successfully!');
            },
            error: function(xhr){
                // Display error message
                if(xhr.responseJSON && xhr.responseJSON.error){
                    alert('Error: ' + xhr.responseJSON.error);
                } else {
                    alert('An unexpected error occurred.');
                }
            }
        });
    });

    // Repeat similar AJAX setup for Distillery, Brand, and Bottle Forms

    // AJAX Submission for Distillery Form
    $('#add_distillery_form').submit(function(event){
        event.preventDefault();

        $.ajax({
            url: "{{ url_for('add_distillery') }}",
            type: "POST",
            data: $(this).serialize(),
            success: function(response){
                // Append the new Distillery to the drop-downs
                $('#distillery_id').append('<option value="' + response.dsp + '">' + response.distillery_name + '</option>');
                $('#search_distillery_distillery_id').append('<option value="' + response.dsp + '">' + response.distillery_name + '</option>');

                // Optionally, select the newly added Distillery
                $('#distillery_id').val(response.dsp);

                // Hide the Distillery form
                hideForm('distillery');

                // Clear the form fields
                $('#add_distillery_form')[0].reset();

                alert('Distillery added successfully!');
            },
            error: function(xhr){
                if(xhr.responseJSON && xhr.responseJSON.error){
                    alert('Error: ' + xhr.responseJSON.error);
                } else {
                    alert('An unexpected error occurred.');
                }
            }
        });
    });

    // AJAX Submission for Brand Form
    $('#add_brand_form').submit(function(event){
        event.preventDefault();

        $.ajax({
            url: "{{ url_for('add_brand') }}",
            type: "POST",
            data: $(this).serialize(),
            success: function(response){
                // Append the new Brand to the drop-downs
                $('#brand_id').append('<option value="' + response.brand_id + '">' + response.brand_name + '</option>');
                $('#search_bottle_brand').append('<option value="' + response.brand_id + '">' + response.brand_name + '</option>');

                // Optionally, select the newly added Brand
                $('#brand_id').val(response.brand_id);

                // Hide the Brand form
                hideForm('brand');

                // Clear the form fields
                $('#add_brand_form')[0].reset();

                alert('Brand added successfully!');
            },
            error: function(xhr){
                if(xhr.responseJSON && xhr.responseJSON.error){
                    alert('Error: ' + xhr.responseJSON.error);
                } else {
                    alert('An unexpected error occurred.');
                }
            }
        });
    });

    // AJAX Submission for Bottle Form
    $('#add_bottle_form').submit(function(event){
        event.preventDefault();

        $.ajax({
            url: "{{ url_for('add_bottle') }}",
            type: "POST",
            data: $(this).serialize(),
            dataType: "json",
            success: function(response){
                // Optionally, refresh the page or display a success message
                alert('Bottle added successfully!');
                $('#add_bottle_form')[0].reset();
            },
            error: function(xhr){
                if(xhr.responseJSON && xhr.responseJSON.error){
                    alert('Error: ' + xhr.responseJSON.error);
                } else {
                    alert('An unexpected error occurred.');
                }
            }
        });
    });

    // AJAX Submission for Deleting Records
    function deleteRecord(table, id) {
        console.log(`Attempting to delete record from table: ${table}, ID: ${id}`);
        if(confirm('Are you sure you want to delete this record?')){
            $.ajax({
                url: "/assignment/delete/" + id,
                type: "POST",
                data: {
                    table: table,
                    id: id
                },
                success: function(response){
                    console.log('Delete response:', response);
                    if(response.success){
                        alert('Record deleted successfully!');
                        // Remove the row from the table
                        $('#record_' + table + '_' + id).remove();
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function(xhr){
                    console.error('Delete error:', xhr);
                    if(xhr.responseJSON && xhr.responseJSON.error){
                        alert('Error: ' + xhr.responseJSON.error);
                    } else {
                        alert('An unexpected error occurred.');
                    }
                }
            });
        }
    }

    // AJAX Submission for Searching Records
    $('#search_parent_company_form').submit(function(event){
        event.preventDefault();

        $.ajax({
            url: "{{ url_for('search_records') }}",
            type: "POST",
            data: {
                table: 'parent_company',
                parent_company_name: $('#search_pc_name').val(),
                city: $('#search_pc_city').val(),
                country: $('#search_pc_country').val()
            },
            success: function(response){
                let resultsDiv = $('#search_parent_company_results');
                resultsDiv.empty();

                if(response.results.length === 0){
                    resultsDiv.append('<p>No Parent Companies found.</p>');
                } else {
                    let table = '<table class="table table-striped">';
                    table += '<thead><tr><th>ID</th><th>Name</th><th>Website</th><th>Address 1</th><th>Address 2</th><th>City</th><th>State</th><th>Postal Code</th><th>Country</th><th>Actions</th></tr></thead><tbody>';
                    response.results.forEach(function(record){
                        table += `<tr id="record_parent_company_${record.parent_company_id}">
                                    <td>${record.parent_company_id}</td>
                                    <td>${record.parent_company_name}</td>
                                    <td>${record.website || ''}</td>
                                    <td>${record.address_1 || ''}</td>
                                    <td>${record.address_2 || ''}</td>
                                    <td>${record.city || ''}</td>
                                    <td>${record.state || ''}</td>
                                    <td>${record.postal_code || ''}</td>
                                    <td>${record.country || ''}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="openEditModal('parent_company', ${record.parent_company_id})">Edit</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteRecord('parent_company', ${record.parent_company_id})">Delete</button>
                                    </td>
                                  </tr>`;
                    });
                    table += '</tbody></table>';
                    resultsDiv.append(table);
                }
            },
            error: function(xhr){
                if(xhr.responseJSON && xhr.responseJSON.error){
                    alert('Error: ' + xhr.responseJSON.error);
                } else {
                    alert('An unexpected error occurred.');
                }
            }
        });
    });

    // Repeat similar AJAX search setups for Distillery, Brand, and Bottle Searches

    $('#search_distillery_form').submit(function(event){
        event.preventDefault();

        $.ajax({
            url: "{{ url_for('search_records') }}",
            type: "POST",
            data: {
                table: 'distillery',
                distillery_name: $('#search_dist_name').val(),
                parent_company_id: $('#search_dist_parent').val(),
                country: $('#search_dist_country').val()
            },
            success: function(response){
                let resultsDiv = $('#search_distillery_results');
                resultsDiv.empty();

                if(response.results.length === 0){
                    resultsDiv.append('<p>No Distilleries found.</p>');
                } else {
                    let table = '<table class="table table-striped">';
                    table += '<thead><tr><th>DSP</th><th>Name</th><th>Parent Company ID</th><th>Website</th><th>Address 1</th><th>Address 2</th><th>City</th><th>State</th><th>Postal Code</th><th>Country</th><th>Actions</th></tr></thead><tbody>';
                    response.results.forEach(function(record){
                        table += `<tr id="record_distillery_${record.dsp}">
                                    <td>${record.dsp}</td>
                                    <td>${record.distillery_name}</td>
                                    <td>${record.parent_company_id}</td>
                                    <td>${record.website || ''}</td>
                                    <td>${record.address_1 || ''}</td>
                                    <td>${record.address_2 || ''}</td>
                                    <td>${record.city || ''}</td>
                                    <td>${record.state || ''}</td>
                                    <td>${record.postal_code || ''}</td>
                                    <td>${record.country || ''}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="openEditModal('distillery', '${record.dsp}')">Edit</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteRecord('distillery', '${record.dsp}')">Delete</button>
                                    </td>
                                  </tr>`;
                    });
                    table += '</tbody></table>';
                    resultsDiv.append(table);
                }
            },
            error: function(xhr){
                if(xhr.responseJSON && xhr.responseJSON.error){
                    alert('Error: ' + xhr.responseJSON.error);
                } else {
                    alert('An unexpected error occurred.');
                }
            }
        });
    });

    // Similarly update search_brand_form and search_bottle_form
</script>
<!-- Edit Record Modal -->
<div class="modal fade" id="editRecordModal" tabindex="-1" aria-labelledby="editRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editRecordForm">
          <div class="modal-header">
            <h5 class="modal-title" id="editRecordModalLabel">Edit Record</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Dynamic Form Fields Will Be Injected Here -->
            <div id="editFormFields">
              <!-- Example Fields (Adjust Based on Model) -->
              <div class="mb-3">
                <label for="edit_name" class="form-label">Name</label>
                <input type="text" class="form-control" id="edit_name" name="name" required>
              </div>
              <!-- Add other fields as necessary -->
              <!-- Date Fields -->
              <div class="mb-3">
                <label for="edit_date_purchased" class="form-label">Date Purchased</label>
                <input type="date" class="form-control" id="edit_date_purchased" name="date_purchased">
              </div>
              <!-- Continue adding fields based on Bottle model -->
            </div>
            <!-- Hidden Fields -->
            <input type="hidden" id="edit_table" name="table">
            <input type="hidden" id="edit_id" name="id">
            <!-- CSRF Token -->
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}